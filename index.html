<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Image Generator</title>
    <!-- Use Tailwind CSS for a modern, responsive design -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Configure Tailwind to use the Inter font and enable dark mode styling
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          },
        },
      };
    </script>
    <!-- Use Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      .output-content {
        min-height: 400px; /* Ensure content container has a minimum height */
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .loading-spinner {
        border-top-color: #3b82f6;
        -webkit-animation: spin 1s linear infinite;
        animation: spin 1s linear infinite;
      }
      @-webkit-keyframes spin {
        0% { -webkit-transform: rotate(0deg); }
        100% { -webkit-transform: rotate(360deg); }
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 p-4 sm:p-8 flex items-center justify-center min-h-screen">
    <div class="container max-w-4xl w-full mx-auto bg-gray-800 p-6 sm:p-10 rounded-3xl shadow-2xl border border-gray-700">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-center mb-6 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
            AI Image Generator
        </h1>
        <p class="text-center text-gray-400 mb-8 max-w-xl mx-auto">
            Generate stunning images with a simple text prompt.
        </p>

        <!-- Input and Generate Button -->
        <div class="flex flex-col sm:flex-row gap-4 mb-6">
            <input type="text" id="prompt-input" placeholder="A futuristic city at sunset..." class="flex-1 bg-gray-700 text-gray-200 p-4 rounded-xl border border-gray-600 focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-300 placeholder-gray-500">
            <button id="generate-btn" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                <i class="fas fa-magic mr-2"></i>
                Generate
            </button>
        </div>
        
        <!-- Output and loading container -->
        <div id="output-container" class="output-content bg-gray-900 rounded-2xl border-2 border-dashed border-gray-700 transition-all duration-300 flex items-center justify-center p-4">
            <p id="placeholder-text" class="text-gray-500 italic">Your generated content will appear here.</p>
        </div>
        <!-- New container for download button -->
        <div class="flex justify-center mt-4">
            <button id="download-btn" class="hidden bg-green-600 text-white font-bold py-3 px-6 rounded-xl shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-105 active:scale-95">
                <i class="fas fa-download mr-2"></i>
                Download Image
            </button>
        </div>

        <!-- Error/Status Message Box -->
        <div id="status-message" class="mt-4 p-4 text-center rounded-xl font-medium transition-all duration-300 hidden"></div>
    </div>

    <script>
        // Use a function to safely get the app ID and firebase config,
        // which are provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Get DOM elements
        const promptInput = document.getElementById('prompt-input');
        const generateBtn = document.getElementById('generate-btn');
        const outputContainer = document.getElementById('output-container');
        const placeholderText = document.getElementById('placeholder-text');
        const statusMessage = document.getElementById('status-message');
        const downloadBtn = document.getElementById('download-btn'); // New element for the download button

        // State variables
        let isLoading = false;
        let generatedImageUrl = ''; // Store the generated image URL for download

        // API configuration
        const apiKey = "";
        const imagenApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

        // --- UI & State Management Functions ---

        /**
         * Shows the loading state.
         */
        function showLoading() {
            isLoading = true;
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Generating...';
            outputContainer.innerHTML = `
                <div class="loading-spinner w-12 h-12 rounded-full border-4 border-gray-600 border-solid border-t-blue-500"></div>
            `;
            placeholderText.classList.add('hidden');
            statusMessage.classList.add('hidden');
            downloadBtn.classList.add('hidden'); // Hide download button when generating
        }

        /**
         * Hides the loading state.
         */
        function hideLoading() {
            isLoading = false;
            generateBtn.disabled = false;
            generateBtn.innerHTML = '<i class="fas fa-magic mr-2"></i> Generate';
        }

        /**
         * Displays a status or error message.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showStatusMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            if (type === 'success') {
                statusMessage.classList.add('bg-green-500', 'text-white');
                statusMessage.classList.remove('bg-red-500', 'text-white');
            } else {
                statusMessage.classList.add('bg-red-500', 'text-white');
                statusMessage.classList.remove('bg-green-500', 'text-white');
            }
        }

        // --- Core Generation Logic ---

        /**
         * Handles the main generation process.
         */
        async function handleGenerate() {
            const prompt = promptInput.value.trim();
            if (!prompt) {
                showStatusMessage('Please enter a prompt!', 'error');
                return;
            }

            showLoading();
            outputContainer.innerHTML = ''; // Clear previous content

            try {
                await generateImage(prompt);
            } catch (error) {
                console.error('Generation error:', error);
                showStatusMessage('An error occurred during generation. Please try again.', 'error');
            } finally {
                hideLoading();
            }
        }

        /**
         * Generates an image using the Imagen API.
         * @param {string} prompt - The user's prompt.
         */
        async function generateImage(prompt) {
            let attempt = 0;
            const maxAttempts = 5;
            const initialDelay = 1000; // 1 second

            while (attempt < maxAttempts) {
                try {
                    const payload = {
                        instances: [{ prompt: prompt }],
                        parameters: { "sampleCount": 1 }
                    };

                    const response = await fetch(imagenApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Too many requests. Retrying...');
                        } else {
                            throw new Error(`API error: ${response.statusText}`);
                        }
                    }

                    const result = await response.json();
                    if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
                        const base64Data = result.predictions[0].bytesBase64Encoded;
                        const imageUrl = `data:image/png;base64,${base64Data}`;
                        
                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = prompt;
                        img.className = 'rounded-xl shadow-lg w-full h-auto object-contain';
                        
                        img.onload = () => {
                            outputContainer.innerHTML = '';
                            outputContainer.appendChild(img);
                            showStatusMessage('Image generated successfully!', 'success');
                            generatedImageUrl = imageUrl; // Store URL for download
                            downloadBtn.classList.remove('hidden'); // Show download button
                        };
                        return; // Exit the loop on success
                    } else {
                        throw new Error('Invalid API response format.');
                    }
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed:`, error.message);
                    attempt++;
                    if (attempt < maxAttempts) {
                        const delay = initialDelay * Math.pow(2, attempt);
                        console.log(`Waiting for ${delay / 1000} seconds before retrying...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error; // Re-throw if all attempts fail
                    }
                }
            }
        }

        // --- Download Functionality ---

        /**
         * Triggers the download of the generated image.
         */
        function downloadImage() {
            if (generatedImageUrl) {
                const a = document.createElement('a');
                a.href = generatedImageUrl;
                a.download = `generated-image-${Date.now()}.png`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } else {
                showStatusMessage('No image to download!', 'error');
            }
        }

        // --- Event Listeners ---
        generateBtn.addEventListener('click', handleGenerate);
        downloadBtn.addEventListener('click', downloadImage); // Listen for clicks on the new download button

        promptInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleGenerate();
            }
        });
    </script>
</body>
</html>
